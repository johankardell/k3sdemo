apiVersion: v1
kind: Namespace
metadata:
  name: factory-sim-config
  labels:
    part-of: k3s-demo-factory
    fleet-propagate: "true"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: flux-applier-cluster-admin
  labels:
    fleet-propagate: "true"  # Add label so we can select it
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: flux-applier
    namespace: factory-sim-config
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: k3s-demo-repo
  namespace: factory-sim-config
spec:
  interval: 1m
  url: https://github.com/johankardell/k3sdemo
  ref:
    branch: main
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: factory-app-sync
  namespace: factory-sim-config
spec:
  interval: 10m
  path: "./flux"
  prune: true
  sourceRef:
    kind: GitRepository
    name: k3s-demo-repo
  targetNamespace: default
  serviceAccountName: flux-applier
---
apiVersion: placement.kubernetes-fleet.io/v1beta1
kind: ClusterResourcePlacement
metadata:
  name: deploy-factory-configs
spec:
  resourceSelectors:
    # Select the namespace
    - group: ""
      kind: Namespace
      name: factory-sim-config
      version: v1
    # Select the ClusterRoleBinding explicitly
    - group: rbac.authorization.k8s.io
      kind: ClusterRoleBinding
      name: flux-applier-cluster-admin
      version: v1
  policy:
    placementType: PickAll
